sudo: required
services:
- docker
language: ruby
bundler_args: "--without production"
cache: bundler
stages:
  - lint
  - test
  - pact
  - name: docker
    if: branch = master
  - name: deploy
    if: branch = master
jobs:
  include:
  - stage: lint
    script: bundle exec rubocop -c .rubocop.yml
  - stage: test
    before_script: RAILS_ENV=test bundle exec rails db:create
    script: bundle exec rake spec
    script: bundle exec rake spec:infra
  - stage: pact
    before_script: RAILS_ENV=test bundle exec rails db:create
    script: RAILS_ENV=test bundle exec rake pact:verify
  - stage: docker
    script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD $DOCKER_REGISTRY
    - docker build . --tag $DOCKER_REGISTRY/$REPO
    - docker push $DOCKER_REGISTRY/$REPO
  - stage: deploy
    before_deploy:
    - openssl aes-256-cbc -K $encrypted_f01d31c5d2d1_key -iv $encrypted_f01d31c5d2d1_iv
      -in deploy_rsa.enc -out deploy_rsa -d
    - chmod 600 deploy_rsa
    script: skip
    deploy:
      provider: script
      skip_cleanup: true
      script: ssh -i deploy_rsa $DEPLOY_USER@$DEPLOY_HOST "sh ${DEPLOY_PATH}/bin/update shelf2-backend"
env:
  global:
  - secure: 16NxzuG73q/aCw0yvfujVlpVcJ0F+ol3Zl3x5vHJ/ep1ii7k3Fv9cOBpUgoh/UgbqEM/IcvSGuHxIKvA1x+B7pCEgf0cYarS8l/kUqJ89rcW138EoLuSDaA+wcuvvharuH8pEMiXdyd+zxLhfXnUjGLeTzJ6ubgjxIMdSed2cyx1jCnGqWlc74fYyxulBfWLD4jrA5zqpxnZFw7ak3IOn5+g2Lz4Jy6SxryycoqA9I9cFQCQCFZ4T5vWx9z4yddOud4705Mg6OXI0kFH4j4PwZLIhp3dgL3+8INYr/DLas4FkgnlDyJVcTPhmnSTqpAI/JOJLSoOO/B8rifAQor4TXFS33Vzwn4qMIuOKp7QFJj/PkzgUdYDigt544LcVCPRDRfZOA/joL2+Wpd6RfYkv+AKapjR7Mn9kzmNTeWDwBiZnuryueZtp7kUwhYoZDNjN3uADxyOAIe1k/9I/9uipEl6VWx8xoV5INQwdRwLvXHj4VYWGTqalqG/meWAqhs4I6hxle+MFL/zdlCuQW1vdAMVht9/bcNmClZyOQFU9Ub3jL2EBPp/P8fD4UtU0GstYalaFFW/WKQLSWYxYVrkLB1/M7VPHZUjqW5KEkFNO8gHcXSaMgbWIp5/q3UURKNe5EBqP4Ym7pNcu6gTxSWJIWqW6GLTxJ6din+X6L001G8=
  - secure: mxe+PXbxWzmCyAfZXv0GOov994ddUTrVcjIfOZdgKQGayLzInDSJedzOk6PkTaSCY/+pMtYrr0/1tHL+6Nuw/LWXVtz3as4RbH+GEzP5Dj5ZsQ1YRwPWRqPn3YRMKABChOg6F1QT8cg8cUbiFr87rTOwDz9S8UkXQH96ECIdOtvy4KkM2jeNpU/Z3fY/92lXrqfwm6w7IZcaRhXng5K6ZXu8MoIskgmOUashfLEL9UAQTVAzg/tE97hp2ZezLmpe56MPJFEM7Kl97Dt2xNy61WDSkU9DeAr7PK64PDFuozKmXwUGW3JyQ2ObcEHUIqwBO4klAQHBwXtu6IMISsji2el5dFMzLfyICbPrcMXrkIOTR7JClWLPMoWO/G5+i33KMT9EaPXMDd9JuAAXHlstcIXhv6958CAM540odV0jzybYykwhUwLX9yRRqvk4YNzy+KaPnCFenuqWiUbR9FdDDqw2Wk0FG9Qx8QgHLfiLGf0mJX/kQ9tV9ThwMvbqJnvGSgOFafFTjxerkxcCSKm2cnb/SvrnXC3JKnMBxhpL9T+2JXG08VZz9Dvz60ufNFwpFYV2plCUakyBZSuZddLlZUVzltlGNhRwpEASedTC1NnV/wkkv3wDGZMqAnQlRNg6N/pLu6VlAlkMARC0Dj+UU3AvHxpdfGYvm5H4vZlpbGs=
  - secure: MuoRa34CLW6Fx/5US/z/jrY3imCenc6NZ9I6EVOHENnJw3QQDPwOfTgJ4/xhLVSsZr1o+AaR9A7lsmR1pURVFntADh1C9bYrtIycItYHy3MpNB8g0gsc5szI3/uk6fki8VY/x4eVVTGSvEURQE49Bf6FVpxY0IfDORLOwFSkeyToDALb2VfT7TEkeK8EU8Uhnf0ODXaaduL5Dsziid93HOvJJWOQ7Mx5jnbMi6rpLJ//v+xqU3XIS8XYUIY8rO0RIPzHALcxasjezE7o54GR57Vql9uqdqCP5Yeljm86qRvizgAD1IQCkZABQW7cvnJEPHGuNsfUtRfjS76rda+7HDgx+JmR7aSab3hfQ2TFbamnbL/62k50LR6NtgvCCQ/+crkbTncqzKzkxTz/O/Ivcc5iCp5OGOtkoesT0ukhyw+hfi94JHeqGvLr+crpmSy0/JqJWHWVIKtZEEhQqt+YW+eyCJ5rmchPg/2uIirOnCteFBJiXz6HqnrS4HoJsl2ux6RV+ukAS2HbbJQ3Ls/hdVDwArT/y4dunKkV4r/CDd+ArVlF2dEKoaCHzN7LCFdwP/OI7x150rGLNLgJkfOT9dVpNYW2DdsoOD10GzAFtAs60I8u/EHRUwXJxU0DmT3EBlnc6Gc6LpbiJdK/tN9S6sbzehd7CbQK72tMWck0Qz8=
  - secure: rhtFIrR3SW78ykr5Pczv2bpSPb8AbGU+BU6udUD5QWkCgApDFuNz0gCv8cwDBR52JmhFC3tgcCgV78jgw2b6R6o+MdGw84wjg6O/VjZMnAhiFxOsTn4FWDDPTqHVMSroePkHJQhIBF2PRYflFA7/atkZ0XR2D1nRcm0kFDM3HlH9uu/P/WzlL+J0gPjjyB2bOzZ6spHzUStBa3246KSV2y/PzGwngYCbxylBrTQWH8OxRxWuJGnxbVWHX0Gph9e7m3dWeOIwUvBfIbx+4STL3iLRzOh9rmA/SxGJEJEeBK+CBBIVdReUVIDxAXu/mHEzWTldsWnZ/AZ0jrqw9qWyGPNbTDcRdaAmMisnT/OjV5yCUCHLEfJDrxUraHBiRnGDTC2FDO2/o27pv4bOmx31AwjYkpaVXa8ocd/T6I4T7xj8DTgegTXA40dIVtZlh1Ee8L+AampyyElIbmVDhKmIaEoSCoLewQkQiQ1mo/gYDSNajmin5SWMRwN9YvekUqkc7hLYMLXctj3OrCJQMzyN+lGsdbHupNkD4qR6CpqId6K6uGyOTww2VXhpbrCzNuTZ+X13dYfh8DDq1epL62yJvFDR2Hmvkq9PuUGRRdjEa0yd7ACL/TZaWmpJtWXPzFeKH4QFJ6+N2uelX0P/M3kTW78lzBwoemNzhK0cQ4nEpK4=
  - secure: mqp5gAdrDGDHUTzPfjvoz12URI2XqZP9837YKIKWzW5oVN/3/ldninFDZUMbADMeumgyFM4s9HcOaXi7mYMG3a0nHY5li+8gcVJ8pSNqFS+Wb6Y0b78YdCWJidkKB0oaTN5LwBdPyE2QLZQTei0T3KBbDFS6l1SvlPbOeYBH4QA8RpoB1BMwUlXW/n2hApT8GFCLE1187xSu8pA3bKhEnCxh4CmqcFq2AdUJ17KLz6GBKpvaZPaU2VoYXKIKTUnkIc0j6/n+SwLnrx1zmzZpoj1S4d/y8ZAFNJ1Dzcpl/YGCMAuaqmO2s7Jl/3uBVCxR2qzz+JAhme2sE8PCpZWUWiZLaFQbF+MrLc7LeMiPCR1DMJqARNDEUuEHUuSbV0tYrE+jL4M4G3fRcS8MjZ8wknG/nbvaAttPwYXStJNE/KTFJKWqLw3a2DS8I3fd9LfKybFMxyE8aVX6iZLeFF95ba1EBJVYII4fQIoANyezbz0z+1mqkMDyFNys7nRckKM25btrctEUTBVnakzUFFmZ0RU7TBmc474hDfIc7UOQxjajUvCxHx7snxKkd+iivd0VYx76j6RWpjFQeN+13XqBuDepG2/dvir4bTcdXipFK8MK1li8BPoUBUWiFzzrEGVmR3v2avXxUtj0l6QfEqPI0w5hIagiDyKAjL0ow83rNMs=
  - secure: ldZXLRCkBzPJrlPleBKCECrahxqET/YWUvBkdDmv2qsVJdvGJ6Dkg8i0VuWpGqUJKqGdGPV+Y5L1veIMLyXLBv9kDrfZglE1SgaXdLfMTzWfik6qoxSKOLbFbtBfSxc29yaP9zNNNLVomAXREjF+crRRxF+1lu8+x7i9FGDuKh/uG5Wyi+apO4RUlev0HhdF1v8MzPrGtNUgb7c0ZSvK8poQSY0aUWTIkw6NvxUVyaveUAkiSH7QrI9eABUSH/2jXO1IM/nBX0nZTR7J+BTWgxoDe2r4iCB8GGGBRqr9sZA/k5ElXs17Ta04wxzsJkXzScRYyfkLekvLc6jmzd59M1xop9DBTPFzADTg8RyqfZJi8kB5XyLCfD8wGlLhcBo2zbIVbKp9REBLKPIJBlM3oBgc2NFCAhbhXq7662RPfXgX9dhIkHpaWjwQs2xlPBVrjgv0NHIKlltgnn10mPNG8M5pxwXvA6NBpOPXgH+ajDnBdbVYE7u5cKZ8X/s/HHnThsVhkn3oMna/xzknUb/QAc0NE9VHV3GCnQWPoH3IiACTT0DReVk/nClfe1TJsNcQocXJ96Bzs10I97zs+JKF4Ni+iWFwCo224w+5AeVs+WLJ8Ag0Nfk4QdBo9ukaVrIivtaHVXSeg9zzloXCs8uTLDtvCfYq+PdxdQRnUg8DDeM=
  - secure: KnSsIYWYtcnGCF0X/mWIJ3hqr6f55dUTApUQEyqkmfM7mDOEiS/YRaFbZybLa829CFIZZmreAb3eLiF2M+NiPgFg626nPYNF+1I1ETPM4oYh+QHydIJO2oYeNoTKrRyBIV+fcmPlJJoLX0ll30YrSepGQrK7uTZneneHkY89q4JgGg8BOgIzF1I0Ne6LdQOq90rsOqYs2B04al2Eenv4WTaGGOZlLMO/+ggqju2Hf7Pc8ZahevTI9TWGu7wmMXRngfD0wYU5RGsB2YVA4LIMSqC6E8wsoeDHrNc3ErcDFtBI7/HrcKjW0sUtPtl04Y6YkBhlP7LcTgyk8RSoUG1wUCuYZO+g1J7Rt0Dxp3U5kinU2aUkf/pBKR/ebE78IGXk8+tcsSrPW15A35+etpi7P4Avpa+s8EEj2xIA9+4lFvoPZZ3hruu9MkCAAso7Gk2Lpxfz5Vj7g3R/B7IBmAyaCQ/qrMhyC90OWaIs7j7ve62j56toeocnR6lUGWRge4TsubDQsLkQ1vu2s+El0Y0Gdlr/WAj+7juyP4UE3XRLnov5KtAidHblfjHiZLM0WxySuy55XiakO9Y95r2igcL9cgCvwYybV1bpTPPn782Lf3gIteRIDXRoLO1ZVgM4CmKTH29JajBZ9REeZbvnIX+H6jEt391xB2EBEZ+S/BD/Yng=
addons:
  ssh_known_hosts:
    secure: ZZtCsdHc8uLgZkwoJPXZ0svl55EeC/Z40zmsrPLX3Lj7bJ0ng1GIhpLQvanitijHwLE4WShfrA47zTlNgfm0pCavpImuQxW2q8CfyFE3bjN3ZYWx2LvdIw6nA89ePVwG555YK62Z4BVKAa4gUpvs3X3KpfJSRqCY+jwMH3+8+XDlQa7wnUW/v3h3e/i02/uUS2KsG35QnUyySK4f4Oe4ntrKQbzlu0ZhM7FrODwZSnFOIpSWmaadbWiiWASu/UV5DLFOcn1O00XITHmINFYyXFxgkqQMLmpjnkf4/yeDvDbsdwy+9EQSrlJqaeawMTKJ5gD4eR4ef2A1ovoSXwWfeIt/aMeP5jYJIK7OkNoaChwaf5Cl913tbbQz/Xtduc9EKwTOHKkFo+l6BUh5bkX8F5WS05K3c54G0Op68DyEomVeq4ot67BD7HbWEr5tpPfHF1sZ6GQysOprv2PukAqMqmd0rnDSwZ69Oi9Fe0nx0ELnMbDEfB0mXx7ffy6mzgyqMOsxqUCHJXn5J9KEItTFK6Zj/EZVPks69spSgVuNRFUUlWQRGVIkGOu237UOPx15G0sfsvcfeOx6tZvNu0UlYe/vVOmYgwtkovfiSXnKTqclOeaXNsFmEnCE2Nr+cM9i4+mqw16jWARKrmo6W1wP5TEm1i6f2SnTQr8mQqU02Tw=
